#!/bin/bash

source $HOME/.local/share/js-shell-lib/tui.sh

TEMPLATE_HOME="$HOME/projects/project-templates"
PROJECT_HOME="$HOME/projects"

die() {
    echo "$*" 1>&2
    exit 1
}

check_template_exists() {
    return $(test -d "$TEMPLATE_HOME/$1")
}

list_dirs() {
    find $1/* -prune -type d -printf "%f\n"
}

choose_template() {
    list_dirs "${TEMPLATE_HOME}" | fzf --border=rounded --border-label="Select a project template"
}

latest_directory() {
    /bin/ls -1ct "$1" | head -1
}

main() {
    local template_name="$1"
    if [ -z "${template_name}" ]; then
        template_name=$(choose_template) || die "Interrupted."
    fi

    echo "Checking $template_name"
    check_template_exists "$template_name" || die "Template not found."
    cookiecutter "$TEMPLATE_HOME" --directory "$template_name" --output-dir "$PROJECT_HOME" || die "create-project: Error while executing Cookiecutter. Exiting."
    echo "Project is successfully created."
    tui_confirm "Do you want to edit the project?" && edit-project "${PROJECT_HOME}/$(latest_directory "${PROJECT_HOME}")"
}

list_templates() {
    ls -1 "$TEMPLATE_HOME"
}

main $@
